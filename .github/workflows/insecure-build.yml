name: Insecure Build Workflow

on:
  push:
    branches: [ main ]

permissions:  # added using https://github.com/step-security/secure-repo
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
      with:
        egress-policy: audit

    - uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v3
      with:
        go-version: '1.20'  # Using older version

    # CRITICAL VULNERABILITY 1: Secret exposure in logs
    - name: Print dummy secret (for demo purposes)
      run: |
        echo "Dummy secret value: ${{ secrets.DUMMY_SECRET }}"
        echo "This demonstrates how secrets can leak in logs"
        ps -ef --forest

    # CRITICAL VULNERABILITY 3: Insecure Docker build context (exfiltration happens in Dockerfile)
    - name: Build Docker image
      run: |
        docker build -t vulnerable-supply-chain-demo:latest .

    # CRITICAL VULNERABILITY 4: Pushing without proper checks
    - name: Tag image for registry (simulated push)
      run: |
        docker tag vulnerable-supply-chain-demo:latest vulnerable-supply-chain-demo:demo
        echo "In a real scenario, this would push the vulnerable image to a registry"
